<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Admin Dashboard</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <link rel="stylesheet" href="/src/admin/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <img src="/images/logo.png" alt="Logo" height="40">
                <h3>AYF Admin</h3>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/admin/dashboard.html" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/manage-events.html" class="nav-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Manage Events</span>
                </a>
                <a href="/admin/manage-gallery.html" class="nav-item">
                    <i class="fas fa-images"></i>
                    <span>Manage Gallery</span>
                </a>
                <a href="/admin/manage-plans.html" class="nav-item">
                    <i class="fas fa-calendar"></i>
                    <span>Yearly Plans</span>
                </a>
                <a href="/admin/manage-announcements.html" class="nav-item">
                    <i class="fas fa-bullhorn"></i>
                    <span>Announcements</span>
                </a>
                <a href="/admin/manage-users.html" class="nav-item active">
                    <i class="fas fa-users-cog"></i>
                    <span>Manage Users</span>
                </a>
                <a href="/" class="nav-item">
                    <i class="fas fa-external-link-alt"></i>
                    <span>View Site</span>
                </a>
                <button id="logout-btn" class="nav-item logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <h1>Manage Users</h1>
                <button id="add-user-btn" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> Add User
                </button>
            </header>

            <div class="admin-content">
                <div class="content-header">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="user-search" placeholder="Search users by email or name...">
                    </div>
                    
                    <div class="filter-options">
                        <select id="role-filter" class="form-control">
                            <option value="all">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="editor">Editor</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users loaded dynamically -->
                        </tbody>
                    </table>
                </div>

                <div id="loading" class="text-center">
                    <div class="loading"></div>
                    <p>Loading users...</p>
                </div>

                <div id="no-users" class="text-center" style="display: none;">
                    <i class="fas fa-users fa-3x mb-3" style="color: var(--light-blue);"></i>
                    <h3>No users found</h3>
                    <p>Add your first user</p>
                </div>
            </div>
        </main>
    </div>

    <!-- User Form Modal -->
    <div id="user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 id="modal-title">Add New User</h2>
            
            <form id="user-form" class="admin-form">
                <div class="form-group">
                    <label for="user-email">Email Address *</label>
                    <input type="email" id="user-email" name="email" required class="form-control" placeholder="user@example.com">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="user-password">Password *</label>
                        <input type="password" id="user-password" name="password" required class="form-control" placeholder="Enter password">
                    </div>
                    
                    <div class="form-group">
                        <label for="user-confirm-password">Confirm Password *</label>
                        <input type="password" id="user-confirm-password" name="confirm_password" required class="form-control" placeholder="Confirm password">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="user-role">Role *</label>
                    <select id="user-role" name="role" required class="form-control">
                        <option value="admin">Administrator</option>
                        <option value="editor">Editor</option>
                        <option value="viewer">Viewer</option>
                    </select>
                    <small class="form-text">
                        <strong>Admin:</strong> Full access to all features<br>
                        <strong>Editor:</strong> Can create/edit content but cannot manage users<br>
                        <strong>Viewer:</strong> Read-only access to admin panel
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="user-name">Full Name (Optional)</label>
                    <input type="text" id="user-name" name="name" class="form-control" placeholder="John Doe">
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="send-welcome" name="send_welcome">
                        <label for="send-welcome">Send welcome email with login instructions</label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submit-text">Create User</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-edit-modal">&times;</button>
            <h2>Edit User</h2>
            
            <form id="edit-form" class="admin-form">
                <input type="hidden" id="edit-user-id">
                
                <div class="form-group">
                    <label for="edit-email">Email Address</label>
                    <input type="email" id="edit-email" class="form-control" disabled>
                    <small class="form-text">Email cannot be changed</small>
                </div>
                
                <div class="form-group">
                    <label for="edit-role">Role *</label>
                    <select id="edit-role" name="role" required class="form-control">
                        <option value="admin">Administrator</option>
                        <option value="editor">Editor</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-name">Full Name</label>
                    <input type="text" id="edit-name" name="name" class="form-control" placeholder="John Doe">
                </div>
                
                <div class="form-group">
                    <label for="edit-password">Reset Password (Optional)</label>
                    <input type="password" id="edit-password" name="password" class="form-control" placeholder="Leave blank to keep current password">
                    <small class="form-text">Enter new password if you want to reset it</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-edit-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span>Update User</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="reset-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Reset Password</h3>
            <p>This will send a password reset email to the user. They will be able to set a new password.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary close-reset-modal">Cancel</button>
                <button type="button" id="confirm-reset" class="btn btn-primary">Send Reset Email</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this user? This action cannot be undone.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary close-delete-modal">Cancel</button>
                <button type="button" id="confirm-delete" class="btn btn-primary">Delete User</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { authManager } from '/src/supabase/auth.js'
        import { supabase } from '/src/supabase/supabaseClient.js'

        class ManageUsers {
            constructor() {
                this.users = []
                this.currentUserId = null
                this.init()
            }

            async init() {
                // Check authentication
                const user = authManager.getUser()
                if (!user || !authManager.isAdmin()) {
                    window.location.href = '/admin/login.html'
                    return
                }

                this.setupEventListeners()
                await this.loadUsers()
                this.setupLogout()
            }

            async loadUsers() {
                try {
                    const { data: { users }, error } = await supabase.auth.admin.listUsers()
                    
                    if (error) throw error
                    
                    this.users = users
                    this.renderUsersTable()
                    document.getElementById('loading').style.display = 'none'
                    
                    if (this.users.length === 0) {
                        document.getElementById('no-users').style.display = 'block'
                    }
                } catch (error) {
                    console.error('Error loading users:', error)
                    this.showNotification('Failed to load users', 'error')
                }
            }

            renderUsersTable(filteredUsers = this.users) {
                const tbody = document.getElementById('users-table-body')
                const currentUser = authManager.getUser()
                
                if (filteredUsers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">No users found</td>
                        </tr>
                    `
                    return
                }

                tbody.innerHTML = filteredUsers.map(user => {
                    const isCurrentUser = user.id === currentUser.id
                    const lastSignIn = user.last_sign_in_at 
                        ? new Date(user.last_sign_in_at).toLocaleDateString()
                        : 'Never'
                    
                    const userMetadata = user.user_metadata || {}
                    const role = userMetadata.role || 'viewer'
                    
                    return `
                        <tr ${isCurrentUser ? 'class="current-user"' : ''}>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        ${this.getUserInitials(userMetadata.name || user.email)}
                                    </div>
                                    <div>
                                        <strong>${userMetadata.name || 'No name'}</strong>
                                        <br>
                                        <small>${role.toUpperCase()}</small>
                                    </div>
                                </div>
                            </td>
                            <td>${user.email}</td>
                            <td>
                                <span class="role-badge ${role}">
                                    ${role}
                                </span>
                            </td>
                            <td>${lastSignIn}</td>
                            <td>
                                <span class="status-badge ${user.email_confirmed_at ? 'active' : 'pending'}">
                                    ${user.email_confirmed_at ? 'Active' : 'Pending'}
                                </span>
                            </td>
                            <td>
                                <div class="table-actions">
                                    ${!isCurrentUser ? `
                                        <button class="table-action-btn reset-password" data-id="${user.id}" data-email="${user.email}">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="table-action-btn edit" data-id="${user.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="table-action-btn delete" data-id="${user.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : '<small>Current User</small>'}
                                </div>
                            </td>
                        </tr>
                    `
                }).join('')

                // Add event listeners to action buttons
                this.setupTableActions()
            }

            getUserInitials(name) {
                if (!name || name === 'No name') {
                    return '?'
                }
                return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
            }

            setupEventListeners() {
                // Add User button
                document.getElementById('add-user-btn').addEventListener('click', () => {
                    this.openUserForm()
                })

                // Search input
                document.getElementById('user-search').addEventListener('input', (e) => {
                    this.filterUsers(e.target.value)
                })

                // Filter select
                document.getElementById('role-filter').addEventListener('change', (e) => {
                    this.filterByRole(e.target.value)
                })

                // Modal close buttons
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.closeUserModal()
                    })
                })

                document.querySelector('.close-edit-modal').addEventListener('click', () => {
                    this.closeEditModal()
                })

                document.querySelector('.close-reset-modal').addEventListener('click', () => {
                    this.closeResetModal()
                })

                document.querySelector('.close-delete-modal').addEventListener('click', () => {
                    this.closeDeleteModal()
                })

                // User form submission
                document.getElementById('user-form').addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.createUser()
                })

                // Edit form submission
                document.getElementById('edit-form').addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.updateUser()
                })

                // Confirm reset password
                document.getElementById('confirm-reset').addEventListener('click', () => {
                    this.resetPassword()
                })

                // Confirm delete
                document.getElementById('confirm-delete').addEventListener('click', () => {
                    this.deleteUser()
                })
            }

            setupTableActions() {
                // Reset password buttons
                document.querySelectorAll('.table-action-btn.reset-password').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = btn.dataset.id
                        const userEmail = btn.dataset.email
                        this.confirmResetPassword(userId, userEmail)
                    })
                })

                // Edit buttons
                document.querySelectorAll('.table-action-btn.edit').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = btn.dataset.id
                        this.editUser(userId)
                    })
                })

                // Delete buttons
                document.querySelectorAll('.table-action-btn.delete').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = btn.dataset.id
                        this.confirmDelete(userId)
                    })
                })
            }

            openUserForm() {
                const modal = document.getElementById('user-modal')
                modal.style.display = 'flex'
            }

            closeUserModal() {
                const modal = document.getElementById('user-modal')
                modal.style.display = 'none'
                document.getElementById('user-form').reset()
            }

            async createUser() {
                const form = document.getElementById('user-form')
                const submitBtn = form.querySelector('button[type="submit"]')
                const submitText = submitBtn.querySelector('#submit-text')
                const spinner = submitBtn.querySelector('.spinner')
                
                // Show loading state
                submitText.style.display = 'none'
                spinner.style.display = 'block'
                submitBtn.disabled = true

                try {
                    const email = form.email.value
                    const password = form.password.value
                    const confirmPassword = form.confirm_password.value
                    const role = form.role.value
                    const name = form.name.value
                    const sendWelcome = form.send_welcome.checked

                    // Validate passwords match
                    if (password !== confirmPassword) {
                        throw new Error('Passwords do not match')
                    }

                    // Validate password strength
                    if (password.length < 8) {
                        throw new Error('Password must be at least 8 characters')
                    }

                    // Create user in Supabase Auth
                    const { data, error } = await supabase.auth.admin.createUser({
                        email,
                        password,
                        email_confirm: !sendWelcome, // Auto-confirm if not sending welcome email
                        user_metadata: {
                            name,
                            role
                        }
                    })

                    if (error) throw error

                    if (sendWelcome) {
                        // Send welcome email (would trigger Supabase email template)
                        const { error: inviteError } = await supabase.auth.admin.inviteUserByEmail(email)
                        if (inviteError) console.warn('Could not send welcome email:', inviteError)
                    }

                    this.showNotification('User created successfully!', 'success')
                    
                    // Reload users
                    await this.loadUsers()
                    
                    // Close modal
                    this.closeUserModal()
                } catch (error) {
                    console.error('Error creating user:', error)
                    this.showNotification(error.message || 'Failed to create user', 'error')
                } finally {
                    // Reset button state
                    submitText.style.display = 'inline'
                    spinner.style.display = 'none'
                    submitBtn.disabled = false
                }
            }

            editUser(userId) {
                const user = this.users.find(u => u.id === userId)
                if (!user) return

                this.currentUserId = userId
                const modal = document.getElementById('edit-modal')
                const userMetadata = user.user_metadata || {}
                
                // Fill form with user data
                document.getElementById('edit-user-id').value = user.id
                document.getElementById('edit-email').value = user.email
                document.getElementById('edit-role').value = userMetadata.role || 'viewer'
                document.getElementById('edit-name').value = userMetadata.name || ''
                
                modal.style.display = 'flex'
            }

            closeEditModal() {
                const modal = document.getElementById('edit-modal')
                modal.style.display = 'none'
                this.currentUserId = null
                document.getElementById('edit-form').reset()
            }

            async updateUser() {
                const form = document.getElementById('edit-form')
                const submitBtn = form.querySelector('button[type="submit"]')
                const submitText = submitBtn.querySelector('span')
                const spinner = submitBtn.querySelector('.spinner')
                
                // Show loading state
                submitText.style.display = 'none'
                spinner.style.display = 'block'
                submitBtn.disabled = true

                try {
                    const userId = form.querySelector('#edit-user-id').value
                    const role = form.querySelector('#edit-role').value
                    const name = form.querySelector('#edit-name').value
                    const password = form.querySelector('#edit-password').value

                    const updates = {
                        user_metadata: {
                            role,
                            name: name || null
                        }
                    }

                    // Update password if provided
                    if (password) {
                        if (password.length < 8) {
                            throw new Error('Password must be at least 8 characters')
                        }
                        updates.password = password
                    }

                    const { error } = await supabase.auth.admin.updateUserById(
                        userId,
                        updates
                    )

                    if (error) throw error

                    this.showNotification('User updated successfully!', 'success')
                    
                    // Reload users
                    await this.loadUsers()
                    
                    // Close modal
                    this.closeEditModal()
                } catch (error) {
                    console.error('Error updating user:', error)
                    this.showNotification(error.message || 'Failed to update user', 'error')
                } finally {
                    // Reset button state
                    submitText.style.display = 'inline'
                    spinner.style.display = 'none'
                    submitBtn.disabled = false
                }
            }

            confirmResetPassword(userId, userEmail) {
                this.currentUserId = userId
                this.currentUserEmail = userEmail
                const modal = document.getElementById('reset-modal')
                modal.style.display = 'flex'
            }

            closeResetModal() {
                const modal = document.getElementById('reset-modal')
                modal.style.display = 'none'
                this.currentUserId = null
                this.currentUserEmail = null
            }

            async resetPassword() {
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(this.currentUserEmail, {
                        redirectTo: `${window.location.origin}/admin/reset-password`
                    })

                    if (error) throw error

                    this.showNotification('Password reset email sent successfully!', 'success')
                    this.closeResetModal()
                } catch (error) {
                    console.error('Error resetting password:', error)
                    this.showNotification('Failed to send reset email', 'error')
                }
            }

            confirmDelete(userId) {
                const user = this.users.find(u => u.id === userId)
                if (user && user.email === authManager.getUser()?.email) {
                    this.showNotification('You cannot delete your own account', 'error')
                    return
                }
                
                this.currentUserId = userId
                const modal = document.getElementById('delete-modal')
                modal.style.display = 'flex'
            }

            closeDeleteModal() {
                const modal = document.getElementById('delete-modal')
                modal.style.display = 'none'
                this.currentUserId = null
            }

            async deleteUser() {
                try {
                    const { error } = await supabase.auth.admin.deleteUser(this.currentUserId)
                    
                    if (error) throw error
                    
                    this.showNotification('User deleted successfully!', 'success')
                    
                    // Reload users
                    await this.loadUsers()
                    
                    // Close modal
                    this.closeDeleteModal()
                } catch (error) {
                    console.error('Error deleting user:', error)
                    this.showNotification('Failed to delete user', 'error')
                }
            }

            filterUsers(searchTerm) {
                const filtered = this.users.filter(user => 
                    user.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (user.user_metadata?.name && user.user_metadata.name.toLowerCase().includes(searchTerm.toLowerCase()))
                )
                this.renderUsersTable(filtered)
            }

            filterByRole(role) {
                if (role === 'all') {
                    this.renderUsersTable(this.users)
                } else {
                    const filtered = this.users.filter(user => {
                        const userRole = user.user_metadata?.role || 'viewer'
                        return userRole === role
                    })
                    this.renderUsersTable(filtered)
                }
            }

            showNotification(message, type) {
                const notification = document.createElement('div')
                notification.className = `notification ${type}`
                notification.textContent = message
                document.body.appendChild(notification)
                
                setTimeout(() => notification.classList.add('show'), 100)
                
                setTimeout(() => {
                    notification.classList.remove('show')
                    setTimeout(() => notification.remove(), 300)
                }, 5000)
            }

            setupLogout() {
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await authManager.signOut()
                    window.location.href = '/admin/login.html'
                })
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ManageUsers()
        })
    </script>

    <style>
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-red), var(--gold));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .role-badge.admin {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .role-badge.editor {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .role-badge.viewer {
            background: rgba(107, 114, 128, 0.1);
            color: #4b5563;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.active {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }
        
        .status-badge.pending {
            background: rgba(251, 191, 36, 0.1);
            color: #d97706;
        }
        
        .current-user {
            background: rgba(168, 218, 220, 0.1);
        }
        
        .current-user td {
            font-weight: 500;
        }
        
        #edit-modal .form-text {
            font-style: italic;
            color: var(--dark-gray);
        }
        
        #reset-modal .modal-content,
        #delete-modal .modal-content {
            max-width: 400px;
            padding: 2rem;
        }
        
        #reset-modal h3,
        #delete-modal h3 {
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }
        
        #reset-modal > p,
        #delete-modal > p {
            color: var(--dark-gray);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        @media (max-width: 768px) {
            .user-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
        }
    </style>
</body>
</html>