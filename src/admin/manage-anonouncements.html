<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Announcements - Admin Dashboard</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <link rel="stylesheet" href="/src/admin/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <img src="/images/logo.png" alt="Logo" height="40">
                <h3>AYF Admin</h3>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/admin/dashboard.html" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/manage-events.html" class="nav-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Manage Events</span>
                </a>
                <a href="/admin/manage-gallery.html" class="nav-item">
                    <i class="fas fa-images"></i>
                    <span>Manage Gallery</span>
                </a>
                <a href="/admin/manage-plans.html" class="nav-item">
                    <i class="fas fa-calendar"></i>
                    <span>Yearly Plans</span>
                </a>
                <a href="/admin/manage-announcements.html" class="nav-item active">
                    <i class="fas fa-bullhorn"></i>
                    <span>Announcements</span>
                </a>
                <a href="/admin/manage-users.html" class="nav-item">
                    <i class="fas fa-users-cog"></i>
                    <span>Manage Users</span>
                </a>
                <a href="/" class="nav-item">
                    <i class="fas fa-external-link-alt"></i>
                    <span>View Site</span>
                </a>
                <button id="logout-btn" class="nav-item logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <h1>Manage Announcements</h1>
                <button id="add-announcement-btn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Announcement
                </button>
            </header>

            <div class="admin-content">
                <div class="content-header">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="announcement-search" placeholder="Search announcements...">
                    </div>
                    
                    <div class="filter-options">
                        <select id="status-filter" class="form-control">
                            <option value="all">All Status</option>
                            <option value="published">Published</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Author</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="announcements-table-body">
                            <!-- Announcements loaded dynamically -->
                        </tbody>
                    </table>
                </div>

                <div id="loading" class="text-center">
                    <div class="loading"></div>
                    <p>Loading announcements...</p>
                </div>

                <div id="no-announcements" class="text-center" style="display: none;">
                    <i class="fas fa-bullhorn fa-3x mb-3" style="color: var(--light-blue);"></i>
                    <h3>No announcements found</h3>
                    <p>Create your first announcement</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Announcement Form Modal -->
    <div id="announcement-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 id="modal-title">New Announcement</h2>
            
            <form id="announcement-form" class="admin-form">
                <div class="form-group">
                    <label for="announcement-title">Title *</label>
                    <input type="text" id="announcement-title" name="title" required class="form-control" placeholder="Enter announcement title">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="announcement-type">Type *</label>
                        <select id="announcement-type" name="type" required class="form-control">
                            <option value="general">General Announcement</option>
                            <option value="devotional">Devotional</option>
                            <option value="news">News Update</option>
                            <option value="event">Event Update</option>
                            <option value="prayer">Prayer Request</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="announcement-status">Status</label>
                        <select id="announcement-status" name="published" class="form-control">
                            <option value="true">Published</option>
                            <option value="false">Draft</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="announcement-content">Content *</label>
                    <textarea id="announcement-content" name="content" rows="8" required class="form-control" placeholder="Write your announcement here..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submit-text">Publish Announcement</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Announcement Modal -->
    <div id="view-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-view-modal">&times;</button>
            <div id="view-content">
                <!-- Announcement details loaded here -->
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this announcement? This action cannot be undone.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary close-delete-modal">Cancel</button>
                <button type="button" id="confirm-delete" class="btn btn-primary">Delete Announcement</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { authManager } from '/src/supabase/auth.js'
        import { supabase } from '/src/supabase/supabaseClient.js'

        class ManageAnnouncements {
            constructor() {
                this.announcements = []
                this.currentAnnouncementId = null
                this.isEditing = false
                this.init()
            }

            async init() {
                // Check authentication
                const user = authManager.getUser()
                if (!user || !authManager.isAdmin()) {
                    window.location.href = '/admin/login.html'
                    return
                }

                this.setupEventListeners()
                await this.loadAnnouncements()
                this.setupLogout()
            }

            async loadAnnouncements() {
                try {
                    const { data, error } = await supabase
                        .from('announcements')
                        .select('*')
                        .order('created_at', { ascending: false })
                    
                    if (error) throw error
                    
                    this.announcements = data
                    this.renderAnnouncementsTable()
                    document.getElementById('loading').style.display = 'none'
                    
                    if (this.announcements.length === 0) {
                        document.getElementById('no-announcements').style.display = 'block'
                    }
                } catch (error) {
                    console.error('Error loading announcements:', error)
                    this.showNotification('Failed to load announcements', 'error')
                }
            }

            renderAnnouncementsTable(filteredAnnouncements = this.announcements) {
                const tbody = document.getElementById('announcements-table-body')
                
                if (filteredAnnouncements.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">No announcements found</td>
                        </tr>
                    `
                    return
                }

                tbody.innerHTML = filteredAnnouncements.map(announcement => {
                    const date = new Date(announcement.created_at)
                    const typeColors = {
                        'general': 'var(--light-blue)',
                        'devotional': 'var(--gold)',
                        'news': 'var(--primary-red)',
                        'event': 'var(--dark-gold)',
                        'prayer': 'var(--dark-blue)'
                    }
                    
                    return `
                        <tr>
                            <td>
                                <strong>${announcement.title}</strong>
                                <br>
                                <small>${announcement.content.substring(0, 60)}...</small>
                            </td>
                            <td>
                                <span class="type-badge" style="background: ${typeColors[announcement.type] || '#6b7280'};">
                                    ${announcement.type}
                                </span>
                            </td>
                            <td>${announcement.author_id ? 'Author' : 'System'}</td>
                            <td>${date.toLocaleDateString()}</td>
                            <td>
                                <span class="status-badge ${announcement.published ? 'published' : 'draft'}">
                                    ${announcement.published ? 'Published' : 'Draft'}
                                </span>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <button class="table-action-btn view" data-id="${announcement.id}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="table-action-btn edit" data-id="${announcement.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="table-action-btn delete" data-id="${announcement.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `
                }).join('')

                // Add event listeners to action buttons
                this.setupTableActions()
            }

            setupEventListeners() {
                // Add Announcement button
                document.getElementById('add-announcement-btn').addEventListener('click', () => {
                    this.openAnnouncementForm()
                })

                // Search input
                document.getElementById('announcement-search').addEventListener('input', (e) => {
                    this.filterAnnouncements(e.target.value)
                })

                // Filter select
                document.getElementById('status-filter').addEventListener('change', (e) => {
                    this.filterByStatus(e.target.value)
                })

                // Modal close buttons
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.closeAnnouncementModal()
                    })
                })

                document.querySelector('.close-view-modal').addEventListener('click', () => {
                    this.closeViewModal()
                })

                document.querySelector('.close-delete-modal').addEventListener('click', () => {
                    this.closeDeleteModal()
                })

                // Announcement form submission
                document.getElementById('announcement-form').addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.saveAnnouncement()
                })

                // Confirm delete
                document.getElementById('confirm-delete').addEventListener('click', () => {
                    this.deleteAnnouncement()
                })
            }

            setupTableActions() {
                // View buttons
                document.querySelectorAll('.table-action-btn.view').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const announcementId = btn.dataset.id
                        this.viewAnnouncement(announcementId)
                    })
                })

                // Edit buttons
                document.querySelectorAll('.table-action-btn.edit').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const announcementId = btn.dataset.id
                        this.editAnnouncement(announcementId)
                    })
                })

                // Delete buttons
                document.querySelectorAll('.table-action-btn.delete').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const announcementId = btn.dataset.id
                        this.confirmDelete(announcementId)
                    })
                })
            }

            openAnnouncementForm(announcement = null) {
                this.isEditing = !!announcement
                this.currentAnnouncementId = announcement?.id || null
                
                const modal = document.getElementById('announcement-modal')
                const form = document.getElementById('announcement-form')
                const title = document.getElementById('modal-title')
                const submitText = document.getElementById('submit-text')
                const statusSelect = document.getElementById('announcement-status')
                
                if (announcement) {
                    title.textContent = 'Edit Announcement'
                    submitText.textContent = 'Update Announcement'
                    
                    // Fill form with announcement data
                    form.title.value = announcement.title
                    form.type.value = announcement.type
                    statusSelect.value = announcement.published ? 'true' : 'false'
                    form.content.value = announcement.content
                } else {
                    title.textContent = 'New Announcement'
                    submitText.textContent = 'Publish Announcement'
                    form.reset()
                    statusSelect.value = 'true' // Default to published
                }
                
                modal.style.display = 'flex'
            }

            closeAnnouncementModal() {
                const modal = document.getElementById('announcement-modal')
                modal.style.display = 'none'
                this.currentAnnouncementId = null
                this.isEditing = false
            }

            async saveAnnouncement() {
                const form = document.getElementById('announcement-form')
                const submitBtn = form.querySelector('button[type="submit"]')
                const submitText = submitBtn.querySelector('#submit-text')
                const spinner = submitBtn.querySelector('.spinner')
                
                // Show loading state
                submitText.style.display = 'none'
                spinner.style.display = 'block'
                submitBtn.disabled = true

                try {
                    const user = authManager.getUser()
                    const announcementData = {
                        title: form.title.value,
                        type: form.type.value,
                        content: form.content.value,
                        published: form.querySelector('#announcement-status').value === 'true',
                        author_id: user.id
                    }

                    if (this.isEditing && this.currentAnnouncementId) {
                        const { error } = await supabase
                            .from('announcements')
                            .update(announcementData)
                            .eq('id', this.currentAnnouncementId)
                        
                        if (error) throw error
                        this.showNotification('Announcement updated successfully!', 'success')
                    } else {
                        const { error } = await supabase
                            .from('announcements')
                            .insert([announcementData])
                        
                        if (error) throw error
                        this.showNotification('Announcement created successfully!', 'success')
                    }

                    // Reload announcements
                    await this.loadAnnouncements()
                    
                    // Close modal
                    this.closeAnnouncementModal()
                } catch (error) {
                    console.error('Error saving announcement:', error)
                    this.showNotification('Failed to save announcement', 'error')
                } finally {
                    // Reset button state
                    submitText.style.display = 'inline'
                    spinner.style.display = 'none'
                    submitBtn.disabled = false
                }
            }

            viewAnnouncement(announcementId) {
                const announcement = this.announcements.find(a => a.id === announcementId)
                if (!announcement) return

                const modal = document.getElementById('view-modal')
                const content = document.getElementById('view-content')
                const date = new Date(announcement.created_at)
                
                content.innerHTML = `
                    <div class="announcement-view">
                        <div class="announcement-header">
                            <span class="type-badge large" style="background: ${this.getTypeColor(announcement.type)};">
                                ${announcement.type}
                            </span>
                            <span class="status-badge ${announcement.published ? 'published' : 'draft'} large">
                                ${announcement.published ? 'Published' : 'Draft'}
                            </span>
                        </div>
                        
                        <h2>${announcement.title}</h2>
                        
                        <div class="announcement-meta">
                            <span><i class="fas fa-calendar"></i> ${date.toLocaleDateString()}</span>
                            <span><i class="fas fa-user"></i> ${announcement.author_id ? 'Author' : 'System'}</span>
                        </div>
                        
                        <div class="announcement-content">
                            ${announcement.content.split('\n').map(para => `<p>${para}</p>`).join('')}
                        </div>
                    </div>
                `
                
                modal.style.display = 'flex'
            }

            getTypeColor(type) {
                const colors = {
                    'general': 'var(--light-blue)',
                    'devotional': 'var(--gold)',
                    'news': 'var(--primary-red)',
                    'event': 'var(--dark-gold)',
                    'prayer': 'var(--dark-blue)'
                }
                return colors[type] || '#6b7280'
            }

            closeViewModal() {
                const modal = document.getElementById('view-modal')
                modal.style.display = 'none'
            }

            editAnnouncement(announcementId) {
                const announcement = this.announcements.find(a => a.id === announcementId)
                if (announcement) {
                    this.openAnnouncementForm(announcement)
                }
            }

            confirmDelete(announcementId) {
                this.currentAnnouncementId = announcementId
                const modal = document.getElementById('delete-modal')
                modal.style.display = 'flex'
            }

            closeDeleteModal() {
                const modal = document.getElementById('delete-modal')
                modal.style.display = 'none'
                this.currentAnnouncementId = null
            }

            async deleteAnnouncement() {
                try {
                    const { error } = await supabase
                        .from('announcements')
                        .delete()
                        .eq('id', this.currentAnnouncementId)
                    
                    if (error) throw error
                    
                    this.showNotification('Announcement deleted successfully!', 'success')
                    
                    // Reload announcements
                    await this.loadAnnouncements()
                    
                    // Close modal
                    this.closeDeleteModal()
                } catch (error) {
                    console.error('Error deleting announcement:', error)
                    this.showNotification('Failed to delete announcement', 'error')
                }
            }

            filterAnnouncements(searchTerm) {
                const filtered = this.announcements.filter(announcement => 
                    announcement.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    announcement.content.toLowerCase().includes(searchTerm.toLowerCase())
                )
                this.renderAnnouncementsTable(filtered)
            }

            filterByStatus(status) {
                if (status === 'all') {
                    this.renderAnnouncementsTable(this.announcements)
                } else {
                    const filtered = this.announcements.filter(announcement => 
                        status === 'published' ? announcement.published : !announcement.published
                    )
                    this.renderAnnouncementsTable(filtered)
                }
            }

            showNotification(message, type) {
                const notification = document.createElement('div')
                notification.className = `notification ${type}`
                notification.textContent = message
                document.body.appendChild(notification)
                
                setTimeout(() => notification.classList.add('show'), 100)
                
                setTimeout(() => {
                    notification.classList.remove('show')
                    setTimeout(() => notification.remove(), 300)
                }, 5000)
            }

            setupLogout() {
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await authManager.signOut()
                    window.location.href = '/admin/login.html'
                })
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ManageAnnouncements()
        })
    </script>

    <style>
        .type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .type-badge.large {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.published {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }
        
        .status-badge.draft {
            background: rgba(251, 191, 36, 0.1);
            color: #d97706;
        }
        
        .status-badge.large {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .announcement-view {
            padding: 1rem;
        }
        
        .announcement-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .announcement-view h2 {
            color: var(--dark-blue);
            margin-bottom: 1rem;
        }
        
        .announcement-meta {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            color: var(--dark-gray);
        }
        
        .announcement-meta i {
            color: var(--gold);
            margin-right: 0.5rem;
        }
        
        .announcement-content {
            line-height: 1.8;
            color: var(--dark-gray);
        }
        
        .announcement-content p {
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .announcement-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .announcement-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</body>
</html>